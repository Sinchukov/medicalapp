<!-- src/main/resources/static/pharmacy.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <title>Pharmacy</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #controls a { margin-right: 15px; }
        #checkForm { margin-top: 30px; }
        #checkForm input { margin: 5px 10px 5px 0; }
        #checkResult { color: red; margin-top: 10px; }
        /* модалка */
        #modalOverlay {
          display: none;
          position: fixed; top:0; left:0; width:100%; height:100%;
          background: rgba(0,0,0,0.5); z-index:1000;
        }
        #modal {
          background: #fff; padding: 20px;
          width: 300px; margin: 100px auto; border-radius: 5px;
          position: relative;
        }
        #modalClose, #modalPrev, #modalNext {
          cursor: pointer; margin: 0 5px;
          font-size: 1.2em; color: #007BFF;
        }
        #modalClose { position: absolute; top:5px; right:10px; }
    </style>
</head>
<body>
<div id="controls">
    <a href="pharmacy.html">Home</a>
    <a href="pharmacy-items.html">Items</a>
    <a href="#" id="logout">Log Out</a>
</div>

<h2>Personal Info</h2>
<div>
    Type: <span id="type"></span><br>
    Company Name: <span id="companyName"></span><br>
    Email: <span id="email"></span><br>
    Registered: <span id="registered"></span><br>
</div>

<!-- Форма поиска пациента и рецептов -->
<form id="checkForm">
    <h3>Check Patient Recipes</h3>
    <input type="text" id="ln" placeholder="Фамилия" required>
    <input type="text" id="fn" placeholder="Имя" required>
    <input type="text" id="mn" placeholder="Отчество">
    <input type="text" id="seriesAndNumber"
           placeholder="Серия и номер паспорта" required>
    <input type="date" id="issueDate" required>
    <input type="text" id="issuedBy" placeholder="Кем выдан" required>
    <input type="text" id="idNumber" placeholder="ИНН" required>
    <button type="submit">CheckInfo</button>
</form>
<div id="checkResult"></div>

<!-- Модальное окно -->
<div id="modalOverlay">
    <div id="modal">
        <span id="modalClose">✕</span>
        <h3>Recipes</h3>
        <div id="modalContent"></div>
        <div style="text-align:center; margin-top:10px;">
            <span id="modalPrev">←</span>
            <span id="modalNext">→</span>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
      const token = sessionStorage.getItem('token');
      if (!token) {
        location.href = 'login.html';
        return;
      }

      // Загрузить профиль
      const pr = await fetch('/api/pharmacy/profile', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (!pr.ok) {
        alert('Auth error, please login again');
        sessionStorage.clear();
        return location.href = 'login.html';
      }
      const pd = await pr.json();
      document.getElementById('type').innerText       = pd.type;
      document.getElementById('companyName').innerText= pd.companyName;
      document.getElementById('email').innerText      = pd.email;
      document.getElementById('registered').innerText = pd.registered;

      // Logout
      document.getElementById('logout').addEventListener('click', () => {
        sessionStorage.clear();
        location.href = 'login.html';
      });

      // Модалка переменные
      let foundRecipes = [], currentIndex = 0;
      const overlay = document.getElementById('modalOverlay');
      const content = document.getElementById('modalContent');

      function showRecipe(i) {
        const r = foundRecipes[i];
        content.innerHTML = `
          <p><strong>Issued:</strong> ${r.dateIssued}</p>
          <p><strong>Expiry:</strong> ${r.expiryDate}</p>
          <p><strong>Medicine:</strong> ${r.medicine}</p>
          <p><strong>Dosage:</strong> ${r.dosage}</p>
          <p><strong>Doctor:</strong> ${r.doctorEmail}</p>
          <p><strong>Dispensed:</strong>
             ${r.dispensed? '✅':'❌'}</p>
        `;
        overlay.style.display = 'block';
      }

      document.getElementById('modalClose').onclick = () => overlay.style.display = 'none';
      document.getElementById('modalPrev').onclick  = () => {
        if (currentIndex>0) currentIndex--, showRecipe(currentIndex);
      };
      document.getElementById('modalNext').onclick  = () => {
        if (currentIndex<foundRecipes.length-1) currentIndex++, showRecipe(currentIndex);
      };

      // Обработчик формы
      document.getElementById('checkForm').addEventListener('submit', async e => {
        e.preventDefault();
        document.getElementById('checkResult').innerText = '';

        const dto = {
          lastName:               ln.value.trim(),
          firstName:              fn.value.trim(),
          middleName:             mn.value.trim(),
          passportSeriesAndNumber: seriesAndNumber.value.trim(),
          passportIssueDate:      issueDate.value.split('-').reverse().join('.'),
          passportIssuedBy:       issuedBy.value.trim(),
          identificationNumber:   idNumber.value.trim()
        };

        const resp = await fetch('/api/pharmacy/patients/check', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify(dto)
        });

        if (resp.status === 404) {
          return document.getElementById('checkResult').innerText = 'Patient Not Found';
        }
        if (!resp.ok) {
          return document.getElementById('checkResult').innerText = 'Error: ' + resp.status;
        }

        const data = await resp.json();
        if (!Array.isArray(data) || data.length === 0) {
          return document.getElementById('checkResult').innerText = '0 recipes found';
        }

        foundRecipes = data;
        currentIndex = 0;
        showRecipe(0);
      });
    });
</script>
</body>
</html>
